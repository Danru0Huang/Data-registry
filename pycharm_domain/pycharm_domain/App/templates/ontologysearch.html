<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>数据共享及演化工具</title>
    <!-- Import Vue.js -->
    <script src="/static/js/vue.min.js"></script>

    <!-- Import Element UI style file -->
    <link rel="stylesheet" href="/static/element-ui/theme-chalk/index.css">

    <!-- Import Element UI JavaScript file -->
    <script src="/static/element-ui/index.js"></script>

    <!-- Import axios JavaScript file -->
    <script src="/static/js/axios.min.js"></script>

    <!-- Import JointJS JavaScript file -->
    <!-- <script src="https://cdnjs.cloudflare.com/ajax/libs/jointjs/3.4.1/joint.min.js"></script> -->
    <script src="/static/js/joint.min.js"></script>
    <!-- Import JointJS stylesheet -->
    <link rel="stylesheet" href="/static/css/joint.min.css">

    <style>
        .el-header {
            background-color: #B3C0D1;
            color: #333;
            line-height: 60px;
        }

        .el-container {
            height: 680px;
        }

        .el-aside {
            color: #333;
        }

        .text {
            font-size: 14px;
        }

        .item {
            margin-bottom: 18px;
        }
    </style>
</head>
<body>
<div id="app">
    <el-container style="height: auto; border: 1px solid #eee">
        <el-aside width="250px" style="background-color: #545c64">
            <el-row class="tac">
                <el-col :span="24">
                    <el-menu default-active="1" class="el-menu-vertical-demo" @open="handleOpen"
                             @close="handleClose" background-color="#545c64" text-color="#fff"
                             active-text-color="#ffd04b">

                        <a href="/ontology">
                            <el-menu-item index="1">
                                <i class="el-icon-menu"></i>
                                <span slot="title">本体</span>
                            </el-menu-item>
                        </a>

                        <a href="/register">
                            <el-menu-item index="2">
                                <i class="el-icon-menu"></i>
                                <span slot="title">注册</span>
                            </el-menu-item>
                        </a>

                        <a href="/search">
                            <el-menu-item index="3">
                                <i class="el-icon-document"></i>
                                <span slot="title">查询</span>
                            </el-menu-item>
                        </a>

                        <a href="/ontologysearch">
                            <el-menu-item index="4">
                                <i class="el-icon-document"></i>
                                <span slot="title">本体查询</span>
                            </el-menu-item>
                        </a>

                    </el-menu>
                </el-col>
            </el-row>

        </el-aside>

        <el-container>

            <el-main>
                <h2>本体查询</h2>
                <el-input placeholder="请输入你本体的名称..." v-model="searchInput" clearable></el-input>
                <el-button type="primary" icon="el-icon-search" @click="search" round>搜索</el-button>

                <!-- UML 类图容器 -->
                <div id="umlDiagram" style="width: 100%; height: 400px;"></div>
            </el-main>

        </el-container>
    </el-container>
</div>
<script>
    document.addEventListener("DOMContentLoaded", function() {
        new Vue({
            el: '#app',
            data: {
                searchInput: '',
            },
            methods: {
                handleOpen(key, keyPath) {
                    console.log(key, keyPath);
                },
                handleClose(key, keyPath) {
                    console.log(key, keyPath);
                },
                search() {
                    axios.post('/search_ontology', {
                        ontology_name: this.searchInput
                    })
                    .then(response => {
                        console.log("result", response.data.result);
                        this.drawUMLDiagram(response.data.result);
                    })
                    .catch(error => {
                        console.error(error);
                    });
                },
                drawUMLDiagram(result) {
                    console.log("Before creating graph");
                    var graph = new joint.dia.Graph();
                    console.log("After creating graph");

                    try {
                        var paper = new joint.dia.Paper({
                            el: document.getElementById('umlDiagram'),
                            width: 800,
                            height: 400,
                            model: graph,
                            gridSize: 1
                        });
                    } catch (error) {
                        console.error("Error creating joint.dia.Paper:", error);
                        return;
                    }

                    console.log("after gen")

                    var cells = [];

                    // 遍历查询结果中的每个元素
                    result.forEach(function(item, index) {
                        // 创建类节点
                        console.log("foreach")
                        var className = item.className;
                        var x = 50 + index * 200;
                        var y = 50;
                        var classNode = new joint.shapes.uml.Class({
                            position: {
                                x: x,
                                y: y
                            },
                            size: {
                                width: 150,
                                height: 100
                            },
                            name: className,
                            attributes: item.properties // 将属性添加到类节点
                        });
                        cells.push(classNode);
                        // 创建关系
                        if (item.relatedClass) {
                            var targetClassName = Object.keys(item.relatedClass)[0];
                            var relationName = item.relatedClass[targetClassName];
                            var targetClassNode = cells.find(cell => cell.attributes.name ===
                                targetClassName);

                            if (targetClassNode) {
                                var relation = new joint.shapes.uml.Generalization({
                                    source: {
                                        id: classNode.id
                                    },
                                    target: {
                                        id: targetClassNode.id
                                    },
                                    attrs: {
                                        '.marker-target': {
                                            d: 'M 10 0 L 0 5 L 10 10 z',
                                            fill: 'white'
                                        }
                                    }
                                });
                                cells.push(relation);
                                relation.labels([{
                                    position: 0.5,
                                    attrs: {
                                        text: {
                                            text: relationName
                                        } // 设置关系名称
                                    }
                                }]);
                            }
                        }
                    });

                    graph.addCells(cells);
                },
            }
        });
    });
</script>
</body>
</html>
